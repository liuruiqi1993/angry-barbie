---
layout: post
title: 请求
date: 2020-05-05
---
## ajax
检测`window`对象是否有`XMLHttpRequest`属性来确定浏览器是否支持标准的XMLHttpRequest。
因为浏览器的同源策略，所以URL使用的是相对路径。默认情况下，JavaScript在发送AJAX请求时，URL的域名必须和当前页面完全一致。域名要相同（`www.example.com`和`example.com`不同），协议要相同（`http`和`https`不同），端口号要相同（默认是`:80`端口，它和:`8080`就不同）

```
let request = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Mirosoft.XMLHTTP');
request.onreadystatechange = function(){
    if (request.readyState === 4){
        if (request.status === 200){
            console.log(request.responseText)
        }else {
            console.log(request.status)
        }
    }
}
request.open('GET', '/api/categories')
request.send()
```
## 跨域
* 通过Flash插件发送HTTP请求，这种方式可以绕过浏览器的安全限制，但必须安装Flash，并且跟Flash交互。不过Flash用起来麻烦，而且现在用得也越来越少了。
* 通过在同源域名下架设一个代理服务器来转发，JavaScript负责把请求发送到代理服务器`/proxy?url=http://www.sina.com.cn`，代理服务器再把结果返回，这样就遵守了浏览器的同源策略。这种方式麻烦之处在于需要服务器端额外做开发。
* [jsonp](#jsonp)

## jsonp
只能用GET请求，利用了浏览器允许跨域引用JavaScript资源，比如`<script>`、`<img>`、`<iframe>`。

### 原理

1. 定义一个`callbackFunction`，拿到数据后要做什么1. 
2. 请求JSON，可以带参数`params`，必须告知后台你的`callbackFunction`

```
<script type="text/javascript" src="https://www.runoob.com/try/ajax/jsonp.php?jsoncallback=callbackFunction&params=params"></script>
```
	
### 用法

#### 动态生成
```
<script type="text/javascript">
    // 得到航班信息查询结果后的回调函数
    var flightHandler = function(data){
    alert('你查询的航班结果是：票价 ' + data.price + ' 元，' + '余票 ' + data.tickets + ' 张。');
    };

    // 提供jsonp服务的url地址（不管是什么类型的地址，最终生成的返回值都是一段javascript代码）
    var url = "http://flightQuery.com/jsonp/flightResult.aspx?code=CA1998&callback=flightHandler";

    // 创建script标签，设置其属性
    var script = document.createElement('script');
    script.setAttribute('src', url);

    // 把script标签加入head，此时调用开始
    document.getElementsByTagName('head')[0].appendChild(script); 
</script>
```

#### jq
```
$.getJSON("https://www.runoob.com/try/ajax/jsonp.php?jsoncallback=?", params).done().fail().always();
```

## CORS(Cross-Origin Resource Sharing)
Origin表示本域，也就是浏览器当前页面的域。当JavaScript向外域（如sina.com）发起请求后，浏览器收到响应后，首先检查`Access-Control-Allow-Origin`是否包含本域，如果是，则此次跨域请求成功，如果不是，则请求失败，JavaScript将无法获取到响应的任何数据。

跨域能否成功，取决于对方服务器是否愿意给你设置一个正确的`Access-Control-Allow-Origin`，决定权始终在对方手中。

简单请求包括`GET`、`HEAD`和`POST`（`POST`的`Content-Type`类型 仅限`application/x-www-form-urlencoded`、`multipart/form-data`和`text/plain`）

对于`PUT`、`DELETE`以及其他类型如`application/json`的`POST`请求，在发送AJAX请求之前，浏览器会先发送一个`OPTIONS`请求（称为preflighted请求）到这个URL上，询问目标服务器是否接受，浏览器确认服务器响应的`Access-Control-Allow-Methods`头确实包含将要发送的AJAX请求的Method，才会继续发送AJAX

## 状态码
https://www.runoob.com/http/http-status-codes.html